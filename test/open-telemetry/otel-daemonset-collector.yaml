apiVersion: opentelemetry.io/v1beta1
kind: OpenTelemetryCollector
metadata:
  name: otel-daemonset-collector
  namespace: otel
spec:
  mode: daemonset
  serviceAccount: otel-service-account
  env:
    - name: AUTH_TOKEN
      valueFrom:
        secretKeyRef:
          name: otel-secrets
          key: naturalis-observability-token
    - name: NODE_NAME
      valueFrom:
        fieldRef:
          apiVersion: v1
          fieldPath: spec.nodeName
    - name: MY_POD_IP
      valueFrom:
        fieldRef:
          fieldPath: status.podIP
  config:
    {
      "connectors": { },
      "receivers": {
        "kubeletstats": {
          "collection_interval": "10s",
          "auth_type": "serviceAccount",
          "endpoint": "${NODE_NAME}:10250",
          "insecure_skip_verify": true
        }
      },
      "processors": {
        "batch": { },
        "memory_limiter": {
          "check_interval": "5s",
          "limit_percentage": 80,
          "spike_limit_percentage": 25
        },
        "k8sattributes": {
          "filter": {
            "node_from_env_var": "${NODE_NAME}"
          },
          "pod_association": [
            {
              "sources": [
                {
                  "from": "resource_attribute",
                  "name": "k8s.pod.ip"
                }
              ]
            },
            {
              "sources": [
                {
                  "from": "resource_attribute",
                  "name": "k8s.pod.uid"
                }
              ]
            },
            {
              "sources": [
                {
                  "from": "connection"
                }
              ]
            }
          ]
        },
        "transform/host": {
          "metric_statements": [
            {
              "context": "datapoint",
              "statements": [
                'set(attributes["deployment_environment"], "test")',
                'set(attributes["service_namespace"], "naturalis.bii.dissco")',
                'set(attributes["service_name"], "dissco-node")',
                'set(attributes["service_owner"], "soulaine.theocharides@naturalis.nl")',
                'set(attributes["service_team"], "dissco")',
                'set(attributes["node_name"], "${NODE_NAME}")',
                'set(attributes["cluster"], "${CLUSTER_NAME}")''
              ]
            }
          ]
        }
      }
      ,
      "extensions": {
        "health_check": {
          "endpoint": "${MY_POD_IP}:13133"
        },
        "oauth2client/client": {
          "client_id": "naturalis.bii.dissco",
          "client_secret": "${AUTH_TOKEN}",
          "token_url": "https://keycloak.iam.naturalis.io/realms/observability/protocol/openid-connect/token",
          "tls": {
            "insecure": true
          }
        }
      },
      "exporters": {
        "otlp/metrics": {
          "endpoint": "https://metrics.gateway.analytics.naturalis.io:443",
          "auth": {
            "authenticator": "oauth2client/client"
          }
        }
      },
      "service": {
        "extensions": [
          "oauth2client/client",
          "health_check"
        ],
        "pipelines": {
          "metrics": {
            "receivers": [
              "kubeletstats"
            ],
            "processors": [
              "batch",
              "k8sattributes",
              "memory_limiter",
              "transform/host"
            ],
            "exporters": [
              "otlp/metrics"
            ]
          }
        }
      }
    }
  volumeMounts:
    - name: otel-secrets
      mountPath: "/mnt/secrets-store/otel-secrets"
      readOnly: true
  volumes:
    - name: otel-secrets
      csi:
        driver: secrets-store.csi.k8s.io
        readOnly: true
        volumeAttributes:
          secretProviderClass: "otel-secrets"

